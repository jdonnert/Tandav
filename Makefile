# Compilation parameters in 'Config' file

SHELL = /bin/bash # This should always be present in a Makefile

ifndef TANDAV_SYSTYPE
TANDAV_SYSTYPE := ${shell hostname}
endif

CC	 	 = mpicc
OPTIMIZE = -Wall -g -O2 
XTRA_INCL = $(CPPFLAGS)
XTRA_LIBS = $(LDFLAGS)

# machine specifics
ifeq ($(TANDAV_SYSTYPE),DARWIN)
CC       =  mpicc
OPTIMIZE =  -Wall -g -lmpich -O3 -mtune=native -march=native  -fopt-info-vec
XTRA_LIBS = 
XTRA_INCL = 
endif

ifeq ($(TANDAV_SYSTYPE),mach64.ira.inaf.it)
CC       =  mpicc
OPTIMIZE =  -g -O2  -march=bdver1 -mtune=native -mprefer-avx128 -mieee-fp  \
			-minline-all-stringops -fprefetch-loop-arrays --param prefetch-latency=300 -funroll-all-loops 
XTRA_LIBS = -L/home/donnert/Libs/lib
XTRA_INCL = -I/home/donnert/Libs/include
endif

ifeq ($(TANDAV_SYSTYPE),MSI)
CC       =  mpicc
OPTIMIZE =  -Wall -g -O2 -openmp -xhost  -mkl  -ansi-alias-check 
XTRA_LIBS = -lmpich -L$(LD_LIBRARY_PATH)
XTRA_INCL = -I$(INCLUDE)
endif

ifeq ($(TANDAV_SYSTYPE),coma.msi.umn.edu)
CC       =  mpicc
OPTIMIZE =  -Wall -g -O3 -openmp -xhost  -mkl  -ansi-alias-check \
			-ipo -ipo-jobs8
XTRA_LIBS = -lmpich -L$(LD_LIBRARY_PATH)
XTRA_INCL = -I$(INCLUDE)
endif

# end systypes

EXEC = Tandav

SRCDIR = src/

SRCFILES = main.c aux.c cosmology.c domain.c update.c print_settings.c drift.c \
		init.c kick.c setup.c timestep.c unit.c memory.c profile.c \
		sort.c finish.c peano.c accel.c constants.c log.c signal.c comov.c \
		periodic.c select.c properties.c\
		\
	   	IO/io.c IO/read_snapshot.c IO/write_snapshot.c IO/rw_parameter_file.c \
		IO/write_restart_file.c IO/read_restart_file.c  \
		\
		Gravity/gravity_simple.c Gravity/tree_build.c Gravity/tree_accel.c \
		Gravity/tree_update.c Gravity/tree_periodic.c \
		Gravity/gravity_periodic.c

INCLFILES = config.h globals.h cosmology.h unit.h aux.h macro.h proto.h \
	    memory.h profile.h IO/io.h constants.h kick.h setup.h update.h \
		drift.h timestep.h peano.h accel.h log.h signal.h  comov.h \
		periodic.h select.h properties.h \
		\
		Gravity/gravity.h Gravity/gravity_periodic.h \
		\
		../Makefile ../Config

OBJFILES = $(SRCFILES:.c=.o)

OBJS = $(addprefix $(SRCDIR),$(OBJFILES))
INCS = $(addprefix $(SRCDIR),$(INCLFILES))

CFLAGS = -fopenmp -std=c99 -fstrict-aliasing  \
		 $(OPTIMIZE) $(XTRA_INCL) 

LIBS = -lm -lgsl -lgslcblas $(XTRA_LIBS)

# rules

%.o : %.c
	@echo [CC] $@
	@$(CC) $(CFLAGS)  -o $@ -c $<

$(EXEC)	: settings $(OBJS)
	$(CC) $(CFLAGS) $(OBJS) $(LIBS) -o $(EXEC)
	@cd src && ctags -w *.[ch]

$(OBJS)	: $(INCS)

$(SRCDIR)config.h : Config 
	@echo Generating $(SRCDIR)config.h from Config
	@sed '/^#/d; /^$$/d; s/^/#define /g' Config > $(SRCDIR)config.h

$(SRCDIR)print_settings.c : Config	# does not work with sh shell
	@echo Generating $(SRCDIR)print_settings.c from Config
	@echo '/* Autogenerated File  */' >  $(SRCDIR)print_settings.c
	@echo '#include "globals.h"' >>  $(SRCDIR)print_settings.c
	@echo '#include "proto.h"' >>  $(SRCDIR)print_settings.c
	@echo 'void Print_compile_time_settings(){' >> $(SRCDIR)print_settings.c
	@echo '	rprintf("Compiled with : \n"' >> $(SRCDIR)print_settings.c
	@sed '/^#/d; /^$$/d; s/^/"      /g; s/$$/ \\n"/g;' Config >> \
		$(SRCDIR)print_settings.c
	@echo '); return ;}' >> $(SRCDIR)print_settings.c

.PHONY : settings

settings :
	@echo " "
	@echo 'CC = ' $(CC)
	@echo 'SYSTYPE =' $(TANDAV_SYSTYPE)
	@echo 'CFLAGS =' $(CFLAGS)
	@echo 'LDFLAGS =' $(LIBS)
	@echo 'EXEC =' $(EXEC)
	@echo " "

clean : settings
	rm -f $(OBJS) $(EXEC) src/config.h src/print_settings.c
